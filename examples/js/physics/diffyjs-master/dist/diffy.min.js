!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Diffy=t():e.Diffy=t()}(this,function(){return function(e){function t(n){if(i[n])return i[n].exports;var r=i[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var i={};return t.m=e,t.c=i,t.d=function(e,i,n){t.o(e,i)||Object.defineProperty(e,i,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var i=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(i,"a",i),i},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="/",t(t.s=0)}([function(e,t,i){e.exports=i(1)},function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.create=void 0;var r=i(2),o=n(r),a=i(3),s=n(a),d=i(4),u=n(d),l=i(5),c=n(l),h=i(7),f=!1;t.create=function(e){var t=e.resolution,i=e.sensitivity,n=e.threshold,r=e.debug,a=e.onFrame,d=e.sourceDimensions,l=e.containerClassName;if(!window)throw new Error("\n      Diffy.js is meant to be used in the browser. :^)\n      For more info, see: https://github.com/maniart/diffyjs/blob/master/README.md\n    ");if(!("Worker"in window))throw new Error("\n      Diffy.js requires Web Workers.\n      It looks like this environment does not support this feature. :(\n      For more info, see: https://github.com/maniart/diffyjs/blob/master/README.md\n    ");if(f)throw new Error("\n      Yikes! It seems like a Diffy.js instance already exists on this page. :|\n      For more info, see: https://github.com/maniart/diffyjs/blob/master/README.md\n    ");var v=o.default.create({tickFn:s.default,captureFn:u.default,DiffWorker:c.default,roundFn:h.round,win:window,doc:document,resolution:t,sensitivity:i,threshold:n,debug:r,onFrame:a,sourceDimensions:d,containerClassName:l});return f=!0,v}},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),o=function(){function e(t){var i=t.tickFn,r=void 0===i?function(){}:i,o=t.captureFn,a=void 0===o?function(){}:o,s=t.DiffWorker,d=void 0===s?function(){}:s,u=t.roundFn,l=void 0===u?function(){}:u,c=t.win,h=void 0===c?{}:c,f=t.doc,v=void 0===f?{}:f,p=t.debug,g=void 0!==p&&p,m=t.sourceDimensions,w=void 0===m?{w:130,h:100}:m,b=t.onFrame,E=void 0===b?function(){}:b,y=t.sensitivity,C=void 0===y?.2:y,x=t.threshold,k=void 0===x?21:x,D=t.containerClassName,j=void 0===D?"diffy--debug-view":D,F=t.resolution,M=void 0===F?{x:10,y:5}:F;n(this,e);var I=h;this.doc=v;var O={audio:!1,video:{width:130,height:100}};this.captureConfig=Object.assign({},O,{video:{width:w.w,height:w.h}}),this.tickFn=r.bind(I),this.captureFn=a,this.roundFn=l,this.onFrame=E,this.currentImageData=null,this.previousImageData=null,this.resolutionX=M.x,this.resolutionY=M.y,this.sensitivity=C,this.threshold=k,this.debug=g,this.containerClassName=j,this.debugViewCollapsed=!1,this.sourceWidth=w.w,this.sourceHeight=w.h,this.worker=new d,this.initialized=!1,this.VERSION="1.3.2",I.addEventListener("load",this.init.bind(this))}return r(e,[{key:"toVideo",value:function(e,t){t.src=e}},{key:"toCanvas",value:function(e,t){t.getContext("2d").drawImage(e,0,0,t.width,t.height)}},{key:"mirror",value:function(e){var t=e.getContext("2d");return t.translate(e.width,0),t.scale(-1,1),e}},{key:"compare",value:function(e,t){var i=e.data,n=t.data,r=i.length,o=new ArrayBuffer(r);this.worker.postMessage({buffer:o,data1:i,data2:n,sensitivity:this.sensitivity,threshold:this.threshold,width:this.sourceWidth,height:this.sourceHeight})}},{key:"drawBlendImageFromBuffer",value:function(e){this.blendImageData.data.set(new Uint8ClampedArray(e)),this.blendCanvasCtx.putImageData(this.blendImageData,0,0),this.previousImageData=this.currentImageData}},{key:"blend",value:function(e){var t=e.getContext("2d"),i=e.width,n=e.height;this.currentImageData=t.getImageData(0,0,i,n),this.previousImageData=this.previousImageData||t.getImageData(0,0,i,n),this.compare(this.currentImageData,this.previousImageData)}},{key:"createMatrix",value:function(){var e=void 0,t=void 0,i=0,n=[],r=this.sourceWidth,o=this.sourceHeight,a=this.sourceWidth/this.resolutionX,s=this.sourceHeight/this.resolutionY,d=null,u=void 0,l=void 0,c=0;for(e=0;e<r;e+=a){var h=[];for(t=0;t<o;t+=s){for(d=this.blendCanvasCtx.getImageData(e,t,a,s).data,u=d.length,l=u/4;i<l;)c+=(d[4*i]+d[4*i+1]+d[4*i+2])/3,++i;c=this.roundFn(c/l),h.push(c),c=0,i=0}n.push(h)}return n}},{key:"loop",value:function(){this.toCanvas(this.videoEl,this.rawCanvasEl),this.blend(this.rawCanvasEl),this.onFrame(this.createMatrix()),this.tickFn(this.loop.bind(this))}},{key:"init",value:function(){var e=this;this.worker.addEventListener("error",function(e){throw e}),this.worker.addEventListener("message",function(t){var i=t.data;e.drawBlendImageFromBuffer(i)}),this.initDom(this.containerClassName),this.blendCanvasCtx=this.blendCanvasEl.getContext("2d"),this.blendImageData=this.blendCanvasCtx.getImageData(0,0,this.sourceWidth,this.sourceHeight),this.captureFn(this.captureConfig).then(function(t){[e.rawCanvasEl,e.blendCanvasEl].forEach(e.mirror),e.toVideo(t,e.videoEl),e.loop()}),this.initialized=!0}},{key:"createElements",value:function(e){var t=this;this.containerEl=this.doc.createElement("div"),this.containerEl.className=e,this.videoEl=this.doc.createElement("video"),this.videoEl.className="video view",this.videoEl.setAttribute("autoplay",""),this.videoEl.width=this.sourceWidth,this.videoEl.height=this.sourceHeight,this.rawCanvasEl=this.doc.createElement("canvas"),this.rawCanvasEl.className="canvas--raw view",this.rawCanvasEl.width=this.sourceWidth,this.rawCanvasEl.height=this.sourceHeight,this.blendCanvasEl=this.doc.createElement("canvas"),this.blendCanvasEl.className="canvas--blend view",this.blendCanvasEl.width=this.sourceWidth,this.blendCanvasEl.height=this.sourceHeight,this.headerEl=this.doc.createElement("header"),this.headerEl.className="header",this.titleEl=this.doc.createElement("h1"),this.titleEl.className="title",this.titleEl.innerText="Diffy debug view",this.toggleEl=this.doc.createElement("span"),this.toggleEl.className="toggle",this.toggleEl.innerText="-",this.headerEl.addEventListener("click",function(e){e.preventDefault(),[t.videoEl,t.rawCanvasEl,t.blendCanvasEl].forEach(function(e){t.debugViewCollapsed?(e.classList.remove("hidden"),t.toggleEl.innerText="-"):(e.classList.add("hidden"),t.toggleEl.innerText="+")}),t.debugViewCollapsed=!t.debugViewCollapsed}),this.headerEl.appendChild(this.toggleEl),this.headerEl.appendChild(this.titleEl),this.containerEl.appendChild(this.headerEl),this.containerEl.appendChild(this.videoEl),this.containerEl.appendChild(this.rawCanvasEl),this.containerEl.appendChild(this.blendCanvasEl),this.doc.body.appendChild(this.containerEl),this.debug||this.containerEl.classList.add("hidden")}},{key:"injectCssStyles",value:function(){var e=this.doc.createElement("style"),t=this.containerClassName,i="\n      ."+t+' {\n        position: fixed;\n        top: 0;\n        left: 0;\n        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;\n        background-color: #000;\n        border: 4px solid #000;\n        color: #fff;\n      }\n      .'+t+" .header {\n        width: 100%;\n        background-color: #000;\n        font-size: 16px;\n        cursor: pointer;\n      }\n      ."+t+" .title {\n        display: inline;\n        margin-left: 10px;\n        font-weight: 300;\n        letter-spacing: 2px;\n        font-size: 16px;\n      }\n      ."+t+" .toggle { padding: 5px; }\n      ."+t+" .view { padding: 5px; }\n      ."+t+" .view.hidden, ."+t+".hidden { display: none; }\n    ";e.innerHTML=i,this.doc.body.appendChild(e)}},{key:"initDom",value:function(e){this.createElements(e),this.injectCssStyles()}}],[{key:"create",value:function(e){return new this(e)}}]),e}();t.default=o},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)};t.default=n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(e,t,i){var n=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return n?new Promise(function(t,i){n.call(navigator,e,t,i)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))};void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=n);var r=function(e){return navigator.mediaDevices.getUserMedia(e).then(function(e){return window.URL.createObjectURL(e)}).catch(function(e){var t=e.name,i=e.message;return console.error(t+" : "+i)})};t.default=r},function(e,t,i){e.exports=function(){return i(6)('!function(e){function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}var t={};r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},r.p="/",r(r.s=0)}([function(e,r,t){"use strict";var n=t(1),o=void 0,u=void 0,i=void 0,a=void 0,c=void 0,f=function(e){var r=e.data,t=r.buffer,f=r.data1,s=r.data2,d=r.width,l=r.height,p=r.sensitivity,v=r.threshold,b=0;c=1-p,o=new Uint32Array(t);for(var y=0;y<l;++y)for(var g=0;g<d;++g)b=y*d+g,u=(f[4*b]+f[4*b+1]+f[4*b+2])/3/c,i=(s[4*b]+s[4*b+1]+s[4*b+2])/3/c,a=(0,n.polarize)((0,n.abs)(u-i),v),o[b]=255<<24|a<<16|a<<8|a;postMessage(t)};onmessage=f},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});r.createOnceLog=function(){var e=0;return function(){if(e<1){var r;(r=console).log.apply(r,arguments)}e++}},r.$=function(e){return document.querySelector(e)},r.round=function(e){return e+.5>>0},r.abs=function(e){return(e^e>>31)-(e>>31)},r.polarize=function(e,r){return e>r?0:255}}]);',i.p+"7f4c9a3f961bd599bfe2.worker.js")}},function(e,t){var i=window.URL||window.webkitURL;e.exports=function(e,t){try{try{var n;try{var r=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;n=new r,n.append(e),n=n.getBlob()}catch(t){n=new Blob([e])}return new Worker(i.createObjectURL(n))}catch(t){return new Worker("data:application/javascript,"+encodeURIComponent(e))}}catch(e){return new Worker(t)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.createOnceLog=function(){var e=0;return function(){if(e<1){var t;(t=console).log.apply(t,arguments)}e++}},t.$=function(e){return document.querySelector(e)},t.round=function(e){return e+.5>>0},t.abs=function(e){return(e^e>>31)-(e>>31)},t.polarize=function(e,t){return e>t?0:255}}])});